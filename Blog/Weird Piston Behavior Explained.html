<html>
    <head>
        <link rel='stylesheet' href='post.css'></link>
        <script src="https://kit.fontawesome.com/c9acfba105.js" crossorigin="anonymous"></script>
        <script type='text/javascript'>
            function gotop() {
                document.body.scrollTop = 0;
                document.documentElement.scrollTop = 0;
            }
        </script>

        <style>
            #redstone-button {
                display:inline-block;
                padding-left: 5px;
            }
            #restone-button-root {
                position:relative;
            }
            #restone-button-root:hover {
                cursor:pointer;
            }
            .sprite {
                background: url(imgs/Redstone_sprite.png) no-repeat;
                margin: 0 2px 0 5px;
            }
            .lsprite {
                background: url(imgs/Redstone_sprite.png) no-repeat;
                background-size: 160px auto;
            }
            .redstone-block {
                width: 16px;
                height: 16px;
                display: inline-block;
                background-position: 0px 0px;
            }
            .lredstone-block {
                width: 32px;
                height: 32px;
                display: inline-block;
                background-position: 0px 0px;
            }
            .piston-block {
                width: 16px;
                height: 16px;
                display: inline-block;
                background-position: -48px -16px;
            }
            .lpiston-up {
                width: 32px;
                height: 32px;
                display: inline-block;
                background-position: -32px 0px;
            }
            .lpiston-head {
                width: 32px;
                height: 32px;
                display: inline-block;
                background-position: -128px -32px;
            }
            .lpiston-base {
                width: 32px;
                height: 32px;
                display: inline-block;
                background-position: -96px 0px;
            }
            .sticky-piston-block {
                width: 16px;
                height: 16px;
                display: inline-block;
                background-position: -32px -16px;
            }
            .redstone-dust {
                width: 16px;
                height: 16px;
                display: inline-block;
                background-position: -16px -16px;
            }
            .slime-block {
                width: 16px;
                height: 16px;
                display: inline-block;
                background-position: 0px -16px;
            }
            .lslime-block {
                width: 32px;
                height: 32px;
                display: inline-block;
                background-position: 0px -32px;
            }
            .obsidian-block {
                width: 16px;
                height: 16px;
                display: inline-block;
                background-position: -32px 0px; 
            }
            .lobsidian-block {
                width: 32px;
                height: 32px;
                display: inline-block;
                background-position: -64px 0px;
            }

            #slide-root {
                width: 100%;
                position: relative;
            }
            .prev, .next {
                cursor: pointer;
                position: absolute;
                top: 50%;
                padding: 16px;
                margin-top: -22px;
                color: white;
                font-weight: bold;
                font-size: 1em;
                border-radius: 0 3px 3px 0;
            }
            .next {
                right: 0;
                border-radius: 3px 0 0 3px;
            }
            .prev:hover, .next:hover {
                background-color: rgba(0,0,0,0.8);
            }
            .myslide {
                display:none;
                width: 100%;
            }
        </style>
    </head>

    <body>
        <!-- Navigation section -->
        <nav id='nav-bar'>
            <a href='../'>Jiachen Niu</a>
            <ul id='nav-link'>
                <li><a href='../#banner'>Home</a></li>
                <li><a href='../#project-root'>Projects</a></li>
                <li><a href='../Blog/Blog_Main.html'>Blog</a></li>
                <li><a href='../#contact-root'>Contact</a></li>
            </ul>
        </nav>

        <!-- Go top icon -->
        <div id='top-icon' onclick='gotop()'>
            <p>Go Top</p>
            <i class="fas fa-arrow-up"></i>
        </div>

        <!-- Content section -->
        <div id='content-wrapper'>
            <div id='content'>
                <h1>Weird Piston Behavior Explained</h1>
                <p id='content-date'>Oct. 31, 2020, 16:19:51</p>
                <p>
                    A few months ago, I was watching <a href='https://www.youtube.com/watch?v=sW0xqvE5TpY'>ilmango's video</a> on how to build a TNT tree farm in 1.15 (<i>ilmango is a technical Minecrafter who makes great redstone builds and tutorials</i>).
                </p>
                <p>
                    I discovered a piston trick in it which I had never seen before and which contradicted my previous understanding of how "Minecraft Redstone" works. I immediately set out to learn why this trick was ever possible...
                </p>
                <p>
                    Now several months later, I think I finally have an answer.
                </p>

                <h2>Minecraft Redstone Crash Course</h2>
                <p>If you have played Minecraft before or have some basic knowledge of Minecraft redstone, you are free to skip this section.</p>
                <div id='restone-button-root'>
                    <i id='redstone-icon' class="far fa-plus-square"></i><h3 id='redstone-button'>Expand</h3>
                </div>
                <div id='redstone-section' style='display:none;'>
                    <video src='./videos/Redstone_Crash_Crouse.mp4' width='100%' controls preload></video>
                    <br><br>
                    <h3>Basic Redstone Components</h3>
                    <p>
                        Redstone components are like eletric components and allow you to create circuits or contraptions with them.
                    </p>
                    <p>
                        <span class='sprite redstone-block'></span><b>Redstone Block:</b> A power source, like a battery.<br>
                        <span class='sprite piston-block'></span><b>Normal Piston:</b> A piston that can push blocks in front of it when powered.<br>
                        <span class='sprite sticky-piston-block'></span><b>Sticky Piston:</b> A piston that can push (when powered) and pull (when depowered) blocks in front of it.<br>
                        <span class='sprite redstone-dust'></span><b>Redstone Dust:</b> Can transmit power, like a wire.<br>
                        <span class='sprite slime-block'></span><b>Slime Block:</b> A special block that can stick to each other and any other blocks that is adjacent to it. When moved by a piston, all blocks sticked to it will be moved as well.<br>
                        <span class='sprite obsidian-block'></span><b>Obsidian Block:</b> A special block that when placed in the path of pistons moving, will stop pistons from moving. Same applies to blocks attached by slime blocks.
                    </p>
                    <p>
                        We see 4 redstone contraptions in the video.
                    </p>
                    <br class='dots'>
                    <p>
                        The first is a demonstration of the basic movements of a normal piston and a sticky piston.
                    </p>
                    <p>
                        When a redstone block<span class='sprite redstone-block'></span> is adjacent to either piston, the piston will fire and push the block in front of it.<br>
                        When depowered, normal piston<span class='sprite piston-block'></span> will leave the block behind and retract, while sticky piston<span class='sprite sticky-piston-block'></span> will also pull back the block in front of it.
                    </p>
                    <br class='dots'>
                    <p>
                        The second example shows redstone block<span class='sprite redstone-block'></span> can power piston through redstone dust<span class='sprite redstone-dust'></span>, which tranmits power into the piston.
                    </p>
                    <br class='dots'>
                    <p>
                        Finally we have a contraption that uses everything we talked about.
                    </p>
                    <p>
                        When powered by a redstone block<span class='sprite redstone-block'></span> through redstone dust<span class='sprite redstone-dust'></span>, the sticky piston<span class='sprite sticky-piston-block'></span> moves and pushes the slime block<span class='sprite slime-block'></span> directly in front of it.
                    </p>
                    <p>
                        Since there are other slime block<span class='sprite slime-block'></span> adjacent to the pushed block, they moves as well.
                    </p>
                    <p>
                        The white concret blocks, and the redstone block<span class='sprite redstone-block'></span> later being added, are attached to at least one slime block<span class='sprite slime-block'></span>, so they also moves with the slime block<span class='sprite slime-block'></span> chunks.
                    </p>
                    <p>
                        However, when an obsidian block<span class='sprite obsidian-block'></span> is added on top of the slime blocks, the sticky piston doesn't fire even when powered. Similarly, when an obsidian block<span class='sprite obsidian-block'></span> is in the way of blocks retracting, the piston failed to pull those slime blocks back.
                    </p>
                    <br class='dots'>
                    <p>
                        These are the most basic functions of these redstone components. These knowledge should be enough for this discussion.
                    </p>
                </div>

                <h2>Exercise - How will it move?</h2>
                <p>
                    Now as an exercise, let's analyze one contraption that uses some of the blocks I introduced earlier. (If you can't understand some parts of the explaination, please check the previous section)
                </p>
                <p>
                    We have a contraption as such:
                    <div style='text-align: center;'>
                        <table style='display:inline-block;border-collapse: collapse;width:0;border:1px;';>
                            <tr><td><span class='lsprite lslime-block'></span></td><td><span class='lsprite lslime-block'></span></td></tr>
                            <tr><td><span class='lsprite lpiston-up'></span></td><td><span class='lsprite lredstone-block'></span></td></tr>
                        </table>
                    </div>
                    (Note: The piston is a sticky piston)
                </p>
                <p>
                    How will it move once being constructed?
                </p>
                <br class='dots'>
                <br>
                <p>
                    First we notice there is a redstone block next to the piston, so reasonablly the piston will fire and push the slime blocks in front of it.
                </p>
                <p>
                    Since the restone block is attached to one of the slime blocks, they all will be pushed by the piston like so:
                    <div style='text-align: center;'>
                        <table style='display:inline-block;border-collapse: collapse;width:0;border:1px;';>
                            <tr><td><span class='lsprite lslime-block'></span></td><td><span class='lsprite lslime-block'></span></td></tr>
                            <tr><td><span class='lsprite lpiston-head'></span></td><td><span class='lsprite lredstone-block'></span></td></tr>
                            <tr><td><span class='lsprite lpiston-base'></span></td><td></td></tr>
                        </table>
                    </div>
                </p>

                <p>
                    However, once the whole contraption is in this state, the piston is no longer powered by the redstone block (not attached to it).
                </p>
                <p>
                    So, the piston will retract and pull the 3 blocks with it. And the whole contraption is back to the initial stage when it was first constructued.
                </p>
                <br>
                <p>
                    Wait? Doesn't that mean the contraption is in an <b>infinite push-pull loop</b>?
                </p>
                <br>
                <p>
                    You guessed right! That is exactly what will happen if you try it in game.
                </p>

                <p>
                    If you understand this analysis and predict it as the desired behavior for this kind of contraptions as I did, then you will find the following contraption really werid (see demo below).
                    <div style='text-align: center;'>
                        <table style='display:inline-block;border-collapse: collapse;width:0;border:1px;';>
                            <tr><td><span class='lsprite lslime-block'></span></td><td></td></tr>
                            <tr><td><span class='lsprite lslime-block'></span></td><td><span class='lsprite lslime-block'></span></td></tr>
                            <tr><td><span class='lsprite lpiston-up'></span></td><td><span class='lsprite lredstone-block'></span></td></tr>
                        </table>
                    </div>
                </p>

                <p>
                    <video src='./videos/Weird_Behavior.mp4' width='100%' controls preload></video>
                    <br><br>
                </p>

                <p>
                    Somehow the second contraption didn't go crazy as we predicted in the first one despite having all the similarities in construction.
                </p>
                <p>
                    How weird and interesting...
                </p>

                <h2>Why It's Worth Looking Into</h2>
                <p>
                    As a programmer, I find this problem really interesting.
                </p>
                <p>
                    Weird behaviors in a program like such often reveal more than just the problem or bug itself, but also a way for us to analyze the inner workings of the program. In this case, if we can carefully control and analyze how we trigger this weird piston behavior, we may find a way to understand how the Minecraft's piston mechnics is implemented in code!
                </p>
                <p>
                    To solve a problem, the first step is always to understand the problem better and to do some initial research. In this case, there are 2 pieces of information that is crucial to our discussion. Let's review them now.
                </p>

                <h2>Divergent 1: Block 36</h2>
                <p>
                    Minecraft is a game about blocks. Everything from dirt to air to water and even players, are bounded by Minecraft's "blocky rules".
                </p>
                <p>
                    However, just having static blocks certainly isn't enough for Minecraft. It would be like living in a world of static images if there weren't any animation and motion that could bring things to life.
                </p>
                <p>
                    As we saw earlier in the demo, the movement of pistons is not shown with just two static images of the the intial and final state of blocks being pushed and pulled by the pistons. Instead, we perceived a smooth transition of blocks being moved.
                </p>
                <p>
                    If I freeze the game and advance the game one tick at a time (using gnembon's carpet mod <a href='https://github.com/gnembon/fabric-carpet'>here</a>), we can see how the piston moves as the time progresses:<br>
                    <div id='slide-root'>
                        <div class='myslide'>
                            <img src='imgs/Piston-3.png' width=100%>
                        </div>
                        <div class='myslide'>
                            <img src='imgs/Piston-4.png' width=100%>
                        </div>
                        <div class='myslide'>
                            <img src='imgs/Piston-5.png' width=100%>
                        </div>
                        <div class='myslide'>
                            <img src='imgs/Piston-6.png' width=100%>
                        </div>
                        <a class="prev" onclick="plusSlide(-1)">&#10094;</a>
                        <a class="next" onclick="plusSlide(1)">&#10095;</a>
                    </div>
                </p>
                <p>
                    Just like how videos and flip-books animate things, Minecraft shows us a fast series of images of the piston moving at different stages which when combined we perceive as pistons moving continuously.
                </p>

                <p>
                    From the programmers' standpoint, this animation introduces some troubles. As the rest of the world are all static blocks, the programmers need a way to make an exception for those moving blocks to let them temporarily break Minecraft's "blocky rules" and move freely in space. Also they need to mark and track those moving blocks so they can be processed differently with respect to the rest of the world.
                </p>
                <p>
                    "Block 36" or <a href='https://minecraft.gamepedia.com/Piston#Moving_Piston'>"moving_piston" block</a>, as it is now called in game, is created just for such a purpose.
                </p>
                <br class='dots'>
                <p>
                    "Block 36" is an invisible in-game block that is used to represent a regular block that is currently moving.
                </p>
                <p>
                    A "Block 36" contains 2 pieces of information. First, it records what block is currently moving. Second, it keeps track of how far the animation has progressed/how far the blocks has moved.
                </p>
                <p>
                    If it helps in anyway, just think of "Block 36" as a <b>transition block</b>.
                </p>
                <p>
                    It provides a visually smooth transition of one block moving from one place to another without affecting too much on the rest of the world. It's lifecycle looks like this:<br>
                    <img src='imgs/Piston-7.png' style='display:block;margin:auto;max-width:100%;'>
                </p>

                <br class='dots'>
                <p>
                    One other property of "Block 36", which is the most important one in relation to our discussion, is that <span style='font-weight:bold;'>"Block 36" can STOP pistons from moving</span> just like an obsidian block<span class='sprite obsidian-block'></span> (see demo below).
                </p>
                <p>
                    <video src='./videos/Moving_Piston_Block.mp4' width='100%' controls preload></video>
                </p>
                <p>
                    Initially the piston was free to move and could push and pull blocks in front of it. Once an obsidian block<span class='sprite obsidian-block'></span> was placed on the path it is pushing, the piston can no longer fire as it was obstructed by that obsidian block.
                </p>
                <p>
                    Then I ran the command <icode>/fill ~ ~-1 ~ ~ ~-1 ~ minecraft:moving_piston</icode> which changed the block under my feet to be a <icode>moving_piston</icode> block ("Block 36"). Since "Block 36" is invisible, you could see the block under my feet disappeared and I fell into the hole.
                </p>
                <p>
                    The pistons failed to fire after being powered, which proved that "Block 36" can't be pushed and can prevent pistons firing.
                </p>

                <h2>Divergent 2: Block Push Limit and DFS</h2>
                <p>
                    Programming is an art of balancing 
                </p>
                
                <h2>Understand the Problem</h2>
                <p>
                    After some experimenting, the following contraptions fell into infinite push-pull loop after being constructed:
                </p>
                <p>
                    <div style='text-align: center;'>
                        <table style='display:inline-block;border-collapse: collapse;border:1px;width:25%;';>
                            <tr><td><span class='lsprite lredstone-block'></span></td></tr>
                            <tr><td><span class='lsprite lslime-block'></span></td></tr>
                            <tr><td><span class='lsprite lpiston-up'></span></td></tr>
                        </table>
                        <table style='display:inline-block;border-collapse: collapse;border:1px;width:25%;';>
                            <tr><td><span class='lsprite lslime-block'></span></td><td><span class='lsprite lredstone-block'></span></td><td><span class='lsprite lslime-block'></span></td></tr>
                            <tr><td><span class='lsprite lslime-block'></span></td><td><span class='lsprite lslime-block'></span></td><td><span class='lsprite lslime-block'></span></td></tr>
                            <tr><td></td><td><span class='lsprite lpiston-up'></span></td><td></td></tr>
                        </table>
                        <table style='display:inline-block;border-collapse: collapse;border:1px;width:25%;';>
                            <tr><td><span class='lsprite lslime-block'></span></td><td><span class='lsprite lslime-block'></span></td></tr>
                            <tr><td><span class='lsprite lpiston-up'></span></td><td><span class='lsprite lredstone-block'></span></td></tr>
                        </table>
                    </div>
                </p>

                <p>
                    But not those ones:
                </p>
                <p>
                    <div style='text-align: center;'>
                        <table style='display:inline-block;border-collapse: collapse;border:1px;width:25%;';>
                            <tr><td><span class='lsprite lslime-block'></span></td><td><span class='lsprite lredstone-block'></span></td></tr>
                            <tr><td><span class='lsprite lslime-block'></span></td><td></td></tr>
                            <tr><td><span class='lsprite lpiston-up'></span></td><td></td></tr>
                        </table>
                        <table style='display:inline-block;border-collapse: collapse;border:1px;width:25%;';>
                            <tr><td><span class='lsprite lslime-block'></span></td><td><span class='lsprite lslime-block'></span></td><td><span class='lsprite lslime-block'></span></td></tr>
                            <tr><td><span class='lsprite lslime-block'></span></td><td><span class='lsprite lredstone-block'></span></td><td><span class='lsprite lslime-block'></span></td></tr>
                            <tr><td><span class='lsprite lslime-block'></span></td><td><span class='lsprite lslime-block'></span></td><td><span class='lsprite lslime-block'></span></td></tr>
                            <tr><td></td><td><span class='lsprite lpiston-up'></span></td><td></td><td></td></tr>
                        </table>
                        <table style='display:inline-block;border-collapse: collapse;border:1px;width:25%;';>
                            <tr><td><span class='lsprite lslime-block'></span></td><td></td></tr>
                            <tr><td><span class='lsprite lslime-block'></span></td><td><span class='lsprite lslime-block'></span></td></tr>
                            <tr><td><span class='lsprite lpiston-up'></span></td><td><span class='lsprite lredstone-block'></span></td></tr>
                        </table>
                    </div>
                </p>

                <p>
                    Let's leave the first pair for now, and focuse on the last two pairs.
                </p>
                <p>
                    If you
                </p>

                <h3>Useful Links/References:</h3>
                <p>
                    <a href='https://www.tutorialrepublic.com/css-tutorial/css-sprites.php'>Sprite image CSS</a><br>
                    <a href='https://www.w3schools.com/howto/howto_js_slideshow.asp'>Slide show CSS - W3School</a><br>
                    <a href='https://minecraft.fandom.com/wiki/Blocks?file=BlockCSS.png'>Sprite image source - FANDOM</a><br>
                    <a href='https://github.com/gnembon/fabric-carpet'>gnembon carpet mod source code - Github</a>
                    <a href='https://www.reddit.com/r/Minecraft/comments/3hb4fk/block_36_id/'>Block 36 rename - Reddit</a><br>
                    <a href='https://minecraft.gamepedia.com/Piston#Moving_Piston'>Moving Piston Block - MC Wiki</a>
                    <a href='https://minecraft.fandom.com/wiki/Technical_Blocks#:~:text=Piston%20Extension%2C%20or%20Block%2036,in%20the%20world%2C%20is%20black.'>Block 36 Description - FANDOM</a>
                    <a href='https://help.minecraft.net/hc/en-us/articles/360029728772-YouTube-Monetization'>Free use of Minecraft gameplay videos - help.minecraft.net</a>
                </p>
            </div>
        </div>

        <script>
            var section = document.getElementById("redstone-section");
            var icon = document.getElementById("redstone-icon");
            document.getElementById("restone-button-root").onclick = (e) => {
                if (section.style.display === "none") {
                    section.style.display = "block";
                    icon.className = 'far fa-minus-square';
                } else {
                    section.style.display = "none";
                    icon.className = 'far fa-plus-square';
                }
            };
        </script>

        <script>
            var slideIndex = 1;
            showSlide(slideIndex)

            function plusSlide(n) {
                showSlide(slideIndex += n);
            }

            function currentSlide(n) {
                slideIndex = n
                showSlide(slideIndex);
            }

            function showSlide(n) {
                var i;
                var slides = document.getElementsByClassName("myslide");
                var dots = document.getElementsByClassName("dot");
                if(n > slides.length) {
                    slideIndex = 1;
                } else if(n < 1) {
                    slideIndex = slides.length
                }
                for(i = 0; i < slides.length; i++) {
                    if(i == slideIndex-1) {
                        slides[i].style.display = "block";
                    } else {
                        slides[i].style.display = "none";
                    }
                }
            }
        </script>

        <!-- Contact Section -->
        <div id='contact-root'>
            <p>Contact at: harrynjc@gmail.com</p>
            <a href="https://github.com/Hackerry"><i class="fab fa-github"></i></a>
        </div>
    </body>
</html>